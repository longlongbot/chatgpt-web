import{d as D,u as pe,c as b,o as r,a as f,b as t,e as E,F as Y,f as u,r as O,t as m,h as z,n as V,j as L,q as ve,m as ge,g as he,v as me,x as xe,y as we,z as ye,A as _e,k as J,w as U,K as ke,G,_ as W,D as be,C as Ce}from"./index-248db249.js";import{i as Te,d as Q,N as X,M as Ae,H as q,m as Le,a as Be,u as Ie,b as Oe,e as Se,f as $e,_ as Re,g as De}from"./index-5c5f7994.js";const Me={key:1,class:"text-[28px] dark:text-white"},Ne=u("svg",{xmlns:"http://www.w3.org/2000/svg",viewBox:"0 0 32 32","aria-hidden":"true",width:"1em",height:"1em"},[u("path",{d:"M29.71,13.09A8.09,8.09,0,0,0,20.34,2.68a8.08,8.08,0,0,0-13.7,2.9A8.08,8.08,0,0,0,2.3,18.9,8,8,0,0,0,3,25.45a8.08,8.08,0,0,0,8.69,3.87,8,8,0,0,0,6,2.68,8.09,8.09,0,0,0,7.7-5.61,8,8,0,0,0,5.33-3.86A8.09,8.09,0,0,0,29.71,13.09Zm-12,16.82a6,6,0,0,1-3.84-1.39l.19-.11,6.37-3.68a1,1,0,0,0,.53-.91v-9l2.69,1.56a.08.08,0,0,1,.05.07v7.44A6,6,0,0,1,17.68,29.91ZM4.8,24.41a6,6,0,0,1-.71-4l.19.11,6.37,3.68a1,1,0,0,0,1,0l7.79-4.49V22.8a.09.09,0,0,1,0,.08L13,26.6A6,6,0,0,1,4.8,24.41ZM3.12,10.53A6,6,0,0,1,6.28,7.9v7.57a1,1,0,0,0,.51.9l7.75,4.47L11.85,22.4a.14.14,0,0,1-.09,0L5.32,18.68a6,6,0,0,1-2.2-8.18Zm22.13,5.14-7.78-4.52L20.16,9.6a.08.08,0,0,1,.09,0l6.44,3.72a6,6,0,0,1-.9,10.81V16.56A1.06,1.06,0,0,0,25.25,15.67Zm2.68-4-.19-.12-6.36-3.7a1,1,0,0,0-1.05,0l-7.78,4.49V9.2a.09.09,0,0,1,0-.09L19,5.4a6,6,0,0,1,8.91,6.21ZM11.08,17.15,8.38,15.6a.14.14,0,0,1-.05-.08V8.1a6,6,0,0,1,9.84-4.61L18,3.6,11.61,7.28a1,1,0,0,0-.53.91ZM12.54,14,16,12l3.47,2v4L16,20l-3.47-2Z",fill:"currentColor"})],-1),Pe=[Ne],Fe=D({__name:"Avatar",props:{image:{type:Boolean}},setup(l){const p=pe(),i=b(()=>p.userInfo.avatar);return(C,v)=>l.image?(r(),f(Y,{key:0},[t(Te)(t(i))&&t(i).length>0?(r(),E(t(X),{key:0,src:t(i),"fallback-src":t(Q)},null,8,["src","fallback-src"])):(r(),E(t(X),{key:1,round:"",src:t(Q)},null,8,["src"]))],64)):(r(),f("span",Me,Pe))}}),Ue={key:0,class:"dark:text-white w-[4px] h-[20px] block animate-blink"},qe={key:0},Ee=["innerHTML"],Ve=["textContent"],Ze=["textContent"],He=D({__name:"Text",props:{inversion:{type:Boolean},error:{type:Boolean},text:null,loading:{type:Boolean},asRawText:{type:Boolean}},setup(l,{expose:p}){const i=l,C=O(),v=new Ae({linkify:!0,highlight(d,w){if(!!(w&&q.getLanguage(w))){const S=w??"";return T(q.highlight(d,{language:S}).value,S)}return T(q.highlightAuto(d).value,"")}});v.use(Le,{attrs:{target:"_blank",rel:"noopener"}}),v.use(Be,{blockClass:"katexmath-block rounded-md p-[10px]",errorColor:" #cc0000"});const B=b(()=>["text-wrap","min-w-[20px]","rounded-md",i.inversion?"dark:bg-[#a1dc95]":"dark:bg-[#1e1e20]",i.inversion?"message-request":"message-reply",{"text-red-500":i.error}]),I=b(()=>{const d=i.text??"";return i.asRawText?d:v.render(d)});function T(d,w){return`<pre class="code-block-wrapper"><div class="code-block-header"><span class="code-block-header__lang">${w}</span><span class="code-block-header__copy">${m("chat.copyCode")}</span></div><code class="hljs code-block-body ${w}">${d}</code></pre>`}return p({textRef:C}),(d,w)=>(r(),f("div",{class:V(["text-black",t(B)])},[l.loading?(r(),f("span",Ue)):(r(),f("div",{key:1,ref_key:"textRef",ref:C,class:"leading-relaxed break-words"},[l.inversion?(r(),f("div",{key:1,class:"whitespace-pre-wrap",textContent:z(t(I))},null,8,Ze)):(r(),f("div",qe,[l.asRawText?(r(),f("div",{key:1,class:"whitespace-pre-wrap",textContent:z(t(I))},null,8,Ve)):(r(),f("div",{key:0,class:"markdown-body",innerHTML:t(I)},null,8,Ee))]))],512))],2))}});const Ke={class:"flex items-center justify-center flex-shrink-0 h-8 overflow-hidden rounded-full basis-8 mr-2"},je={class:"overflow-hidden text-sm items-start"},ze={class:"flex items-end gap-1 pt-1 flex-row"},Je=D({__name:"index",props:{dateTime:null,text:null,inversion:{type:Boolean},error:{type:Boolean},loading:{type:Boolean}},setup(l){const p=l,i=O(),C=O(p.inversion),v=O();return(B,I)=>(r(),f("div",{ref_key:"messageRef",ref:v,class:V(["flex w-full overflow-hidden p-4",l.inversion?"bg-[#F5F5F5]":"bg-[#F7FEE7]"])},[u("div",Ke,[L(Fe,{image:l.inversion},null,8,["image"])]),u("div",je,[u("div",ze,[L(He,{ref_key:"textRef",ref:i,inversion:!1,error:l.error,text:l.text,loading:l.loading,"as-raw-text":C.value},null,8,["error","text","loading","as-raw-text"])])])],2))}}),Ge={class:"flex flex-col max-w-2xl mx-auto h-full bg-gray-50"},We=ke('<div class="p-5 bg-gray-100"><h2 class="float-left m-5"><span class="text-2xl font-extrabold mr-1">赛博教练，</span><span class="text-2xl text-transparent font-extrabold bg-clip-text bg-gradient-to-r from-yellow-400 via-yellow-500 to-yellow-600 via-brown-500 to-brown-600">为您指路</span></h2></div><div class="clear-right"></div>',2),Qe={class:"overflow-hidden"},Xe={id:"image-wrapper",class:"w-full max-w-screen-xl m-auto dark:bg-[#101014]"},Ye={class:"sticky bottom-0 left-0 flex justify-center"},et={class:"w-full max-w-screen-xl m-auto"},tt={key:0,class:"flex items-center justify-between space-x-2"},at={class:"text-xl text-[#4f555e] dark:text-white"},nt={class:"dark:text-black"},rt=D({__name:"index",setup(l){let p=new AbortController;const i=!1,C=ve(),v=ge();Ie();const{isMobile:B}=he(),{addChat:I,updateChat:T,updateChatSome:d,getChatByUuidAndIndex:w}=Oe(),{scrollRef:Z,scrollToBottom:S,scrollToBottomIfAtBottom:M}=Se(),{usingContext:ee}=$e(),s="1029";v.findAndAddHistoryButNotReload({title:"认知行为型教练",uuid:+s,isEdit:!1});let H=!0;const y=b(()=>v.getChatByUuid(+s)),K=b(()=>y.value.filter(e=>!e.inversion&&!e.error)),x=O(""),g=O(!1),N=O(null),te=me(),{promptList:j}=xe(te);y.value.forEach((e,a)=>{e.loading&&d(+s,a,{loading:!1})});function P(){ne()}function ae(e){return H?(H=!1,`
        假设你扮演一位辅导经验十分丰富的认知型教练。无论我问你什么问题，你的答案都必须是通过一个简短的问题来让我进一步挖掘自己内心真正的想法、不可以直接给我答案或者是建议、不需要解释为何要探讨这些问题、不可以问我会采取哪些行动、不可以是封闭式问题。我的问题是"${e}"。
    `):e}async function ne(){var c;let e=x.value;if(g.value||!e||e.trim()==="")return;p=new AbortController,I(+s,{dateTime:new Date().toLocaleString(),text:e,inversion:!0,error:!1,conversationOptions:null,requestOptions:{prompt:e,options:null}}),S(),g.value=!0,x.value="";let a={};const n=(c=K.value[K.value.length-1])==null?void 0:c.conversationOptions;n&&ee.value&&(a={...n}),I(+s,{dateTime:new Date().toLocaleString(),text:"",loading:!0,inversion:!1,error:!1,conversationOptions:null,requestOptions:{prompt:e,options:{...a}}}),S();try{let o="";await(async()=>{await G({prompt:ae(e),options:a,signal:p.signal,onDownloadProgress:({event:_})=>{const F=_.target,{responseText:k}=F,$=k.lastIndexOf(`
`,k.length-2);let R=k;$!==-1&&(R=k.substring($));try{const h=JSON.parse(R);T(+s,y.value.length-1,{dateTime:new Date().toLocaleString(),text:o+h.text,inversion:!1,error:!1,loading:!1,conversationOptions:{conversationId:h.conversationId,parentMessageId:h.id},requestOptions:{prompt:e,options:{...a}}}),i&&h.detail.choices[0].finish_reason,M()}catch{}}})})()}catch(o){const A=(o==null?void 0:o.message)??m("common.wrong");if(o.message==="canceled"){d(+s,y.value.length-1,{loading:!1}),M();return}const _=w(+s,y.value.length-1);if(_!=null&&_.text&&_.text!==""){d(+s,y.value.length-1,{text:`${_.text}
[${A}]`,error:!1,loading:!1});return}T(+s,y.value.length-1,{dateTime:new Date().toLocaleString(),text:A,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:e,options:{...a}}}),M()}finally{g.value=!1}}async function oe(e){if(g.value)return;p=new AbortController;const{requestOptions:a}=y.value[e];let n=(a==null?void 0:a.prompt)??"",c={};a.options&&(c={...a.options}),g.value=!0,T(+s,e,{dateTime:new Date().toLocaleString(),text:"",inversion:!1,error:!1,loading:!0,conversationOptions:null,requestOptions:{prompt:n,...c}});try{let o="";await(async()=>{await G({prompt:n,options:c,signal:p.signal,onDownloadProgress:({event:_})=>{const F=_.target,{responseText:k}=F,$=k.lastIndexOf(`
`,k.length-2);let R=k;$!==-1&&(R=k.substring($));try{const h=JSON.parse(R);T(+s,e,{dateTime:new Date().toLocaleString(),text:o+h.text,inversion:!1,error:!1,loading:!1,conversationOptions:{conversationId:h.conversationId,parentMessageId:h.id},requestOptions:{prompt:n,...c}}),i&&h.detail.choices[0].finish_reason}catch{}}})})()}catch(o){if(o.message==="canceled"){d(+s,e,{loading:!1});return}const A=(o==null?void 0:o.message)??m("common.wrong");T(+s,e,{dateTime:new Date().toLocaleString(),text:A,inversion:!1,error:!0,loading:!1,conversationOptions:null,requestOptions:{prompt:n,...c}})}finally{g.value=!1}}function se(e){g.value||C.warning({title:m("chat.deleteMessage"),content:m("chat.deleteMessageConfirm"),positiveText:m("common.yes"),negativeText:m("common.no"),onPositiveClick:()=>{v.deleteChatByUuid(+s,e)}})}function re(){g.value||C.warning({title:m("chat.clearChat"),content:m("chat.clearChatConfirm"),positiveText:m("common.yes"),negativeText:m("common.no"),onPositiveClick:()=>{v.clearChatByUuid(+s)}})}function le(e){B.value?e.key==="Enter"&&e.ctrlKey&&(e.preventDefault(),P()):e.key==="Enter"&&!e.shiftKey&&(e.preventDefault(),P())}const ie=b(()=>x.value.startsWith("/")?j.value.filter(e=>e.key.toLowerCase().includes(x.value.substring(1).toLowerCase())).map(e=>({label:e.value,value:e.value})):[]),ce=e=>{for(const a of j.value)if(a.value===e.label)return[a.key];return[]},ue=b(()=>"问一个问题"),de=b(()=>g.value||!x.value||x.value.trim()===""),fe=b(()=>{let e=["p-4"];return B.value&&(e=["sticky","left-0","bottom-0","right-0","p-2","pr-3","overflow-hidden"]),e});return we(()=>{var e;S(),N.value&&!B.value&&((e=N.value)==null||e.focus())}),ye(()=>{g.value&&p.abort()}),(e,a)=>(r(),f("div",Ge,[We,u("main",Qe,[u("div",{id:"scrollRef",ref_key:"scrollRef",ref:Z,class:"h-full overflow-hidden overflow-y-auto"},[u("div",Xe,[u("div",null,[(r(!0),f(Y,null,_e(t(y),(n,c)=>(r(),E(Je,{key:c,"date-time":n.dateTime,text:n.text,inversion:n.inversion,error:n.error,loading:n.loading,onRegenerate:o=>oe(c),onDelete:o=>se(c)},null,8,["date-time","text","inversion","error","loading","onRegenerate","onDelete"]))),128)),u("div",Ye,[J("",!0)])])])],512)]),u("footer",{class:V(t(fe))},[u("div",et,[g.value?J("",!0):(r(),f("div",tt,[L(t(Re),{onClick:re},{default:U(()=>[u("span",at,[L(t(W),{icon:"ri:delete-bin-line"})])]),_:1}),L(t(De),{value:x.value,"onUpdate:value":a[1]||(a[1]=n=>x.value=n),options:t(ie),"render-label":ce},{default:U(({handleInput:n,handleBlur:c,handleFocus:o})=>[L(t(be),{ref_key:"inputRef",ref:N,value:x.value,"onUpdate:value":a[0]||(a[0]=A=>x.value=A),type:"textarea",placeholder:t(ue),autosize:{minRows:1,maxRows:t(B)?4:8},onInput:n,onFocus:o,onBlur:c,onKeypress:le},null,8,["value","placeholder","autosize","onInput","onFocus","onBlur"])]),_:1},8,["value","options"]),L(t(Ce),{type:"primary",disabled:t(de),onClick:P},{icon:U(()=>[u("span",nt,[L(t(W),{icon:"ri:send-plane-fill"})])]),_:1},8,["disabled"])]))])],2)]))}});export{rt as _};
